#!/bin/bash

# defaults
version=""
n_repetitions="10"
models="exp1_con_rho0.05 exp1_con_rho0.10 exp1_con_rho0.15"

input_version="version_TEST"

binnings="sb1,sb2,sb3"

errors="none stat syst norm stat,syst,norm"

# parse command line
function PrintUsage()
{
	echo "PrintUsage $0 <option> <option>"
	echo "OPTIONS:"
	echo "    -version <string>        version of the simulation"
	echo "    -repetitions <integer>   number of repetitions to use"
	echo "    -models <string>         space-separated list of models"
	echo "    -input-version <string>  version of the input"
	echo "    -binnings <string>       comma-separated list of binnings"
	echo "    -errors <string>         space-separated list of error models"
	echo "    -fast                    use settings for a fast check"
}

while [ -n "$1" ]
do
	case $1 in
		"-h" | "-help" | "--help")
			PrintUsage
			exit 0
			;;
		"-version")
			shift
			version="$1"
			;;
		"-repetitions")
			shift
			n_repetitions="$1"
			;;
		"-models")
			shift
			models="$1"
			;;
		"-input-version")
			shift
			input_version="$1"
			;;
		"-binnings")
			shift
			binnings="$1"
			;;
		"-errors")
			shift
			errors="$1"
			;;
		"-fast")
			n_repetitions="5"
			models="exp1_con_rho0.10"
			binnings="sb1"
			;;
		*)
			echo "ERROR: parameter '$1' not understood."
			PrintUsage
			exit 1
			;;
	esac

	shift
done

# check input
if [ -z "$version" ]
then
	echo "ERROR: version not defined."
	PrintUsage
	exit 2
fi

# execute
make -j8 || exit 3

topDir="data/simu/$version"

mkdir -p "$topDir"
cd "$topDir"

$BASE_DIR/.simu_sample_models &> "models.log" || exit 21

for model in $models
do
	echo "* $model"

	mkdir -p "$model"
	cd "$model"

	for error_model in $errors
	do
		echo "  - $error_model"

		mkdir -p "errors_$error_model"
		cd "errors_$error_model"

		e_stat="0"
		e_syst="0"
		e_norm="0"

		if [[ "$error_model" == *"stat"* ]]; then e_stat="1"; fi
		if [[ "$error_model" == *"syst"* ]]; then e_syst="1"; fi
		if [[ "$error_model" == *"norm"* ]]; then e_norm="1"; fi

		run_fits="1"

		for seed in `seq 1 $n_repetitions`
		do
			echo "    -> $seed"

			mkdir -p "seed_$seed"
			cd "seed_$seed"

			$BASE_DIR/.simu_make_histograms -model-file "../../../models.root" -model-obj "$model/g_dsdt_CH" \
				-input-file "$BASE_DIR/data/input/$input_version/import.root" -binnings "$binnings" -seed $seed \
				-sim-stat-err $e_stat -sim-syst-err $e_syst -sim-norm-err $e_norm\
				&> "histograms.log" || exit 22

			if [ "$run_fits" == "1" ]
			then
				$BASE_DIR/.make_fit -input-file "histograms.root" -input-datasets "high_beta" \
					-output-root "fit_high.root" -output-results "fit_high.results" &> "fit_high.log" || exit 23

				$BASE_DIR/.make_fit -input-file "histograms.root" -input-datasets "high_beta,low_beta" \
					-output-root "fit_both.root" -output-results "fit_both.results" &> "fit_both.log" || exit 23
			fi
		
			cd ..
		done

		$BASE_DIR/.simu_process_histograms -seed-min 1 -seed-max $n_repetitions -binnings "$binnings" &> "process_histograms.log" || exit 24

		if [ "$run_fits" == "1" ]
		then
			$BASE_DIR/.simu_process_fits -ref-file "../../models.root" -ref-object "$model/info" -input-pattern "seed_%u/fit_high.root"\
				-seed-min 1 -seed-max $n_repetitions -output "process_fits_high.root" &> "process_fits_high.log" || exit 25

			$BASE_DIR/.simu_process_fits -ref-file "../../models.root" -ref-object "$model/info" -input-pattern "seed_%u/fit_both.root"\
				-seed-min 1 -seed-max $n_repetitions -output "process_fits_both.root" &> "process_fits_both.log" || exit 25
		fi

		cd ..
	done

	cd ..
done
